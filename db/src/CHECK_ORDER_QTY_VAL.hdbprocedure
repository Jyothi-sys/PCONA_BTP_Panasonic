PROCEDURE CHECK_ORDER_QTY_VAL(PO VARCHAR(10),PO_ITEM VARCHAR(5),OUT STATUS VARCHAR(10))
AS
BEGIN
DECLARE QTY DECIMAL(10,2)=0;
DECLARE OPEN_QTY DECIMAL(10,2)=0;
DECLARE AB_QTY DECIMAL(10,2)=0;
DECLARE ID INT=1;

SELECT IFNULL(OrderQuantity,0) INTO QTY DEFAULT 0 FROM BTP_PANASONIC_A_PURCHASEORDERITEM
WHERE PURCHASEORDER_PURCHASEORDER=PO AND PURCHASEORDERITEM=PO_ITEM;

/*SELECT SUM(IFNULL(QUANITY,0)) INTO OPEN_QTY DEFAULT 0 FROM BTP_PANASONIC_POCONFIRMATIONDATA
WHERE PURCHASEORDER=PO AND PURCHASEORDERITEM=PO_ITEM
AND Status IS NULL
GROUP BY PURCHASEORDER,PURCHASEORDERITEM;*/

OPEN_QTY=QTY;

SELECT SUM(IFNULL(QUANITY,0)) INTO AB_QTY DEFAULT 0 FROM BTP_PANASONIC_POCONFIRMATIONDATA
WHERE PURCHASEORDER=PO AND PURCHASEORDERITEM=PO_ITEM
AND Status IS NULL
GROUP BY PURCHASEORDER,PURCHASEORDERITEM;

--STATUS=TO_VARCHAR(OPEN_QTY)||TO_VARCHAR(AB_QTY);


IF(OPEN_QTY<AB_QTY)
THEN
BEGIN
    STATUS='F';
    update BTP_PANASONIC_POCONFIRMATIONDATA 
    SET STATUS='E',MESSAGE='Confirmation quantity is greater than Order quantity'
    WHERE PURCHASEORDER=PO AND PURCHASEORDERITEM=PO_ITEM
    AND (STATUS IS NULL);
    
    SELECT (MAX(ID)+1) INTO ID DEFAULT 1 FROM BTP_PANASONIC_POSTATUSMONITORING;
/* Implementation: Passing PurchaseOrderItem at the time of insertion on POSTATUSMONITORING
                                Change on : 28-05-2024
                                Author : Kanchan */

    INSERT INTO BTP_PANASONIC_POSTATUSMONITORING(ID,PO,STATUS,MESSAGE,PURCHASEORDERITEM) 
    VALUES(ID,PO,'E','Confirmation quantity is greater than Order quantity for Item:'||PO_ITEM,PO_ITEM);

    COMMIT;
END;
ELSE 
STATUS='T';
END IF;


END